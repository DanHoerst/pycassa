

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Connecting to a Replica Set &mdash; pycassa v0.5.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pycassa v0.5.0 documentation" href="../index.html" />
    <link rel="up" title="Examples" href="index.html" />
    <link rel="next" title="Custom Type Example" href="custom_type.html" />
    <link rel="prev" title="Geospatial Indexing Example" href="geo.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="custom_type.html" title="Custom Type Example"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="geo.html" title="Geospatial Indexing Example"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">pycassa v0.5.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Examples</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="connecting-to-a-replica-set">
<h1>Connecting to a Replica Set<a class="headerlink" href="#connecting-to-a-replica-set" title="Permalink to this headline">¶</a></h1>
<p>PyMongo makes working with <a class="reference external" href="http://dochub.mongodb.org/core/rs">replica sets</a> easy. Here we&#8217;ll launch a new
replica set and show how to handle both initialization and normal
connections with PyMongo.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Replica sets require server version <strong>&gt;= 1.6.0</strong>. Support
for connecting to replica sets also requires PyMongo version <strong>&gt;=
1.8.0</strong>.</p>
</div>
<div class="admonition-see-general-mongodb-documentation admonition seealso">
<p class="first admonition-title">See general MongoDB documentation</p>
<p class="last"><a class="reference external" href="http://dochub.mongodb.org/core/rs" name="connecting-to-a-replica-set"><em>rs</em></a></p>
</div>
<div class="section" id="starting-a-replica-set">
<h2>Starting a Replica Set<a class="headerlink" href="#starting-a-replica-set" title="Permalink to this headline">¶</a></h2>
<p>The main <a class="reference external" href="http://dochub.mongodb.org/core/rs">replica set documentation</a> contains extensive information
about setting up a new replica set or migrating an existing MongoDB
setup, be sure to check that out. Here, we&#8217;ll just do the bare minimum
to get a three node replica set setup locally.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Replica sets should always use multiple nodes in
production - putting all set members on the same physical node is
only recommended for testing and development.</p>
</div>
<p>We start three <tt class="docutils literal"><span class="pre">mongod</span></tt> processes, each on a different port and with
a different dbpath, but all using the same replica set name &#8220;foo&#8221;. In
the example we use the hostname &#8220;morton.local&#8221;, so replace that with
your hostname when running:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>hostname
morton.local
<span class="nv">$ </span>mongod --replSet foo/morton.local:27018,morton.local:27019 --rest
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mongod --port 27018 --dbpath /data/db1 --replSet foo/morton.local:27017 --rest
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mongod --port 27019 --dbpath /data/db2 --replSet foo/morton.local:27017 --rest
</pre></div>
</div>
</div>
<div class="section" id="initializing-the-set">
<h2>Initializing the Set<a class="headerlink" href="#initializing-the-set" title="Permalink to this headline">¶</a></h2>
<p>At this point all of our nodes are up and running, but the set has yet
to be initialized. Until the set is initialized no node will become
the primary, and things are essentially &#8220;offline&#8221;.</p>
<p>To initialize the set we need to connect to a single node and run the
initiate command. Since we don&#8217;t have a primary yet, we&#8217;ll need to
tell PyMongo that it&#8217;s okay to connect to a slave/secondary:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s">&quot;morton.local:27017&quot;</span><span class="p">,</span> <span class="n">slave_okay</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We could have connected to any of the other nodes instead,
but only the node we initiate from is allowed to contain any
initial data.</p>
</div>
<p>After connecting, we run the initiate command to get things started
(here we just use an implicit configuration, for more advanced
configuration options see the replica set documentation):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;replSetInitiate&quot;</span><span class="p">)</span>
<span class="go">{u&#39;info&#39;: u&#39;Config now saved locally.  Should come online in about a minute.&#39;,</span>
<span class="go"> u&#39;info2&#39;: u&#39;no configuration explicitly specified -- making one&#39;, u&#39;ok&#39;: 1.0}</span>
</pre></div>
</div>
<p>The three <tt class="docutils literal"><span class="pre">mongod</span></tt> servers we started earlier will now coordinate
and come online as a replica set.</p>
</div>
<div class="section" id="id1">
<h2>Connecting to a Replica Set<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>The initial connection as made above is a special case for an
uninitialized replica set. Normally we&#8217;ll want to connect
differently. A connection to a replica set can be made using the
normal <tt class="xref py py-meth docutils literal"><span class="pre">Connection()</span></tt> constructor, specifying
one or more members of the set. For example, any of the following
will create a connection to the set we just created:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">Connection</span><span class="p">(</span><span class="s">&quot;morton.local&quot;</span><span class="p">)</span>
<span class="go">Connection([u&#39;morton.local:27019&#39;, &#39;morton.local:27017&#39;, u&#39;morton.local:27018&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Connection</span><span class="p">(</span><span class="s">&quot;morton.local:27018&quot;</span><span class="p">)</span>
<span class="go">Connection([u&#39;morton.local:27019&#39;, u&#39;morton.local:27017&#39;, &#39;morton.local:27018&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Connection</span><span class="p">(</span><span class="s">&quot;morton.local&quot;</span><span class="p">,</span> <span class="mi">27019</span><span class="p">)</span>
<span class="go">Connection([&#39;morton.local:27019&#39;, u&#39;morton.local:27017&#39;, u&#39;morton.local:27018&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Connection</span><span class="p">([</span><span class="s">&quot;morton.local:27018&quot;</span><span class="p">,</span> <span class="s">&quot;morton.local:27019&quot;</span><span class="p">])</span>
<span class="go">Connection([&#39;morton.local:27019&#39;, u&#39;morton.local:27017&#39;, &#39;morton.local:27018&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Connection</span><span class="p">(</span><span class="s">&quot;mongodb://morton.local:27017,morton.local:27018,morton.local:27019&quot;</span><span class="p">)</span>
<span class="go">Connection([&#39;morton.local:27019&#39;, &#39;morton.local:27017&#39;, &#39;morton.local:27018&#39;])</span>
</pre></div>
</div>
<p>The nodes passed to <tt class="xref py py-meth docutils literal"><span class="pre">Connection()</span></tt> are called
the <em>seeds</em>. As long as at least one of the seeds is online, the
driver will be able to &#8220;discover&#8221; all of the nodes in the set and make
a connection to the current primary.</p>
</div>
<div class="section" id="handling-failover">
<h2>Handling Failover<a class="headerlink" href="#handling-failover" title="Permalink to this headline">¶</a></h2>
<p>When a failover occurs, PyMongo will automatically attempt to find the
new primary node and perform subsequent operations on that node. This
can&#8217;t happen completely transparently, however. Here we&#8217;ll perform an
example failover to illustrate how everything behaves. First, we&#8217;ll
connect to the replica set and perform a couple of basic operations:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s">&quot;morton.local&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">test</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="go">ObjectId(&#39;...&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="go">{u&#39;x&#39;: 1, u&#39;_id&#39;: ObjectId(&#39;...&#39;)}</span>
</pre></div>
</div>
<p>By checking the host and port, we can see that we&#8217;re connected to
<em>morton.local:27017</em>, which is the current primary:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">host</span>
<span class="go">&#39;morton.local&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">port</span>
<span class="go">27017</span>
</pre></div>
</div>
<p>Now let&#8217;s bring down that node and see what happens when we run our
query again:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="nc">pymongo.errors.AutoReconnect</span>: <span class="n-Identifier">...</span>
</pre></div>
</div>
<p>We get an <tt class="xref py py-class docutils literal"><span class="pre">AutoReconnect</span></tt> exception. This means
that the driver was not able to connect to the old primary (which
makes sense, as we killed the server), but that it will attempt to
automatically reconnect on subsequent operations. When this exception
is raised our application code needs to decide whether to retry the
operation or to simply continue, accepting the fact that the operation
might have failed.</p>
<p>On subsequent attempts to run the query we might continue to see this
exception. Eventually, however, the replica set will failover and
elect a new primary (this should take a couple of seconds in
general). At that point the driver will connect to the new primary and
the operation will succeed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
<span class="go">{u&#39;x&#39;: 1, u&#39;_id&#39;: ObjectId(&#39;...&#39;)}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">host</span>
<span class="go">u&#39;morton.local&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">port</span>
<span class="go">27018</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Connecting to a Replica Set</a><ul>
<li><a class="reference internal" href="#starting-a-replica-set">Starting a Replica Set</a></li>
<li><a class="reference internal" href="#initializing-the-set">Initializing the Set</a></li>
<li><a class="reference internal" href="#id1">Connecting to a Replica Set</a></li>
<li><a class="reference internal" href="#handling-failover">Handling Failover</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="geo.html"
                        title="previous chapter">Geospatial Indexing Example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="custom_type.html"
                        title="next chapter">Custom Type Example</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/examples/replica_set.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="custom_type.html" title="Custom Type Example"
             >next</a> |</li>
        <li class="right" >
          <a href="geo.html" title="Geospatial Indexing Example"
             >previous</a> |</li>
        <li><a href="../index.html">pycassa v0.5.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Examples</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, Michael Dirolf.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.3.
    </div>
  </body>
</html>